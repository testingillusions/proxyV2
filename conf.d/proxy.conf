server {
    listen       8011 default_server;
    server_name  localhost;

    # —————— GLOBAL CORS (applies to all locations) ——————
    add_header Access-Control-Allow-Origin  *                             always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS"          always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
    add_header Access-Control-Max-Age       3600                          always;

    # shortcut for OPTIONS preflight
    if ($request_method = OPTIONS) {
        return 204;
    }

    #
    # 1) Special rewrite + proxy for your PHP AJAX path
    #
    location /app/modules/tba/ {
    # CORS (preflight + real)
    add_header Access-Control-Allow-Origin  *                             always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS"          always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
    add_header Access-Control-Max-Age       3600                          always;
    if ($request_method = OPTIONS) {
        return 204;
    }

    # Proxy the exact same URI (/app/modules/tba/ajax.php → /app/modules/tba/ajax.php)
    proxy_pass       http://tba.uglyyellowbunny.com$request_uri;
    proxy_set_header Host              tba.uglyyellowbunny.com;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # If backend ever redirects to its root, map that back under /app/modules/tba/
    proxy_redirect   http://tba.uglyyellowbunny.com/ /app/modules/tba/;
}
    #
    # 2) Catch-all proxy for everything else
    #
    location / {
        proxy_pass       http://tba.uglyyellowbunny.com;
        proxy_set_header Host              tba.uglyyellowbunny.com;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
